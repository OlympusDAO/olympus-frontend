name: Main CI

on:
  push:
    branches: [ master, develop ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build UI for production
      run: |
          yarn install --frozen-lockfile
          yarn lint
          yarn build
      env:
          CI: false
    - name: Run unit tests
      run: |
          yarn test:unit

          # get coverage lines in %
          COVERAGE_LINES_PCT = $(jq .total.lines.pct coverage/coverage-summary.json)
          echo "COVERAGE_LINES_PCT=$(echo ${TOKENS[2]})" >> $GITHUB_ENV

          # get branch name
          REF=${{ github.ref }}
          echo "github.ref: $REF"
          IFS='/' read -ra PATHS <<< "$REF"
          BRANCH_NAME="${PATHS[1]}_${PATHS[2]}"
          echo "BRANCH=$(echo ${BRANCH_NAME})" >> $GITHUB_ENV
    - name: Create coverage badge
      uses: schneegans/dynamic-badges-action@v1.0.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: 4d79fbc5bcabae6ded617354b1896066
        filename: olympus-frontend__coverage__${{ env.BRANCH }}.json
        label: coverage
        message: ${{ env.COVERAGE_LINES_PCT }}%
        color: blue
        namedLogo: jest
        logoColor: lightblue
